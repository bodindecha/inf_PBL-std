const PBL=function(e){let t={API_URL:"/s/PBL/v2/api/",USER:top.USER,HTML:{"tab-menu":(e,t,a)=>'<div class="tab" data-page="'+e+'" onClick="PBL.openPage(this)"><div class="face"><i class="material-icons">'+a+"</i><span>"+t+'</span></div><div class="pop-label"><span>'+t+"</span></div></div>",timeline(e,t){if(!t.sem)return'</div><br><p>ภาคเรียนที่ 2</p><div class="progress slider">';e=e.toString();var a='<div class="sec sec-'+t.deadline+'"><div class="disp" data-title="'+t.title+'"><span class="line"></span><label>'+e+'</label></div><p>กำหนดส่งภายใน</p><output deadline="'+t.deadline+'"></output><div class="asgmt-list">';return Object.keys(t.works).forEach(e=>{a+='<div class="work"><i class="material-icons" work="'+e+'"></i><label>'+t.works[e]+"</label></div>"}),a+="</div></div>"},"work-act":e=>'<button class="blue icon" onClick="PBL.upload(\''+e+'\')" data-title="Replace with new file"><i class="fa fa-upload"></i></button><button class="gray icon" onClick="PBL.file.preview(\''+e+'\')" data-title="View file"><i class="material-icons">visibility</i></button><button class="yellow icon" onClick="PBL.file.print(\''+e+'\')" data-title="Print file"><i class="material-icons">print</i></button><button class="green icon" onClick="PBL.file.download(\''+e+'\')" data-title="Download file"><i class="material-icons">download</i></button><button class="red icon" onClick="PBL.file.remove(\''+e+'\')" data-title="Remove file"><i class="material-icons">delete</i></button>'},tab_menu:{ng:[["group/new","Create","library_add"],["group/join","Join","exit_to_app"]],hg:[["schedule","Schedule","schedule"],["group/information","Information","library_books"],["group/members","Members","group"],["file/documents","Documents","folder"],["file/assignment","Submit work","assignment"],["comments","Comments","comment"]]},timeline:[{isPBL:!0,title:"การจัดกลุ่ม",deadline:"A",works:{n1:"ชื่อโครงงาน",n2:"ครูที่ปรึกษา",n3:"สาขาโครงงาน"},sem:1},{isPBL:!0,title:"ส่งผังความคิด",deadline:"B",works:{mindmap:"ผังความคิดบูรณาการ 8 กลุ่มสาระการเรียนรู้"},sem:1},{isPBL:!1,title:"ส่งใบงาน IS",deadline:"C",works:{"IS1-1":"IS1-1 ประเด็นที่สนใจ","IS1-2":"IS1-2 ปัญหาเกี่ยวกับประเด็นที่สนใจ","IS1-3":"IS1-3 สมมติฐานที่เกี่ยวข้อง"},sem:1},{isPBL:!0,title:"ส่งบทที่ 1-3",deadline:"D",works:{"report-1":"รายงานโครงงานบทที่ 1","report-2":"รายงานโครงงานบทที่ 2","report-3":"รายงานโครงงานบทที่ 3"},sem:1},{sem:0},{isPBL:!0,title:"ส่งบทที่ 4-5",deadline:"E",works:{"report-4":"รายงานโครงงานบทที่ 4","report-5":"รายงานโครงงานบทที่ 5"},sem:2},{isPBL:!0,title:"ส่งเล่มเต็มและอื่นๆ",deadline:"F",works:{"report-all":"รวมเล่มรายงานโครงงาน",abstract:"บทคัดย่อโครงงาน"},sem:2},{isPBL:!0,title:"ส่งโปสเตอร์",deadline:"G",works:{poster:"โปสเตอร์"},sem:2},],MSG:{"delete-group":"Are you sure you want to delete this group and its progress (all your work) ?\nThis action can't be undone.","delete-mbr":"Are you sure you want to delete this member?\nThis action can't be undone.",newLeader:"Are you sure you want to set your friend as the new group leader?\nThis action can't be undone.","del-work":e=>'Are you sure you want to delete group "'+e+"\" file?\nThis action can't be undone."},workload:{mindmap:"แผนผังความคิดบูรณาการ 8 กลุ่มสาระการเรียนรู้","IS1-1":"ใบงาน IS1-1 (ประเด็นที่ต้องการศึกษา)","IS1-2":"ใบงาน IS1-2 (การระบุปัญหา)","IS1-3":"ใบงาน IS1-3 (การระบุสมมติฐาน)","report-1":"เล่มรายงานโครงงานบทที่ 1","report-2":"เล่มรายงานโครงงานบทที่ 2","report-3":"เล่มรายงานโครงงานบทที่ 3","report-4":"เล่มรายงานโครงงานบทที่ 4","report-5":"เล่มรายงานโครงงานบทที่ 5","report-all":"รวมเล่มรายงานโครงงาน (ฉบับเต็ม)",abstract:"บทคัดย่อโครงงาน",poster:"โปสเตอร์"},mbr_settings:["statusOpen","publishWork"]};var a={started:!1,HTML:{},current:{page:"",workType:""},state:{button_freeze:!1,loadInfoOver:!0,loadSettingsOver:!0},notifyJsInited:!1,history:{unsavedPage:[]}},n={freeze:function(){$("main .pages .page.current button, main .tab-selector").attr("disabled",""),a.state.button_freeze=!0},unfreeze:function(){a.state.button_freeze&&($("main .pages .page.current button, main .tab-selector").removeAttr("disabled"),a.state.button_freeze=!1,"group/information"===a.current.page&&(a.state.loadInfoOver=!1,v(a.current.page)))}},i=function(){a.notifyJsInited||(a.notifyJsInited=!0,$.notify.addStyle("PBL-unsaved",{html:'<div><div class="clearfix"><div class="title" data-notify-html="title"></div><div class="form inline"><button class="yellow" name="keep">Keep unsaved changes</button><button class="red hollow" name="load">Load updates</button></div></div></div>'}),$(document).on("click",'main .notifyjs-PBL-unsaved-base [name="keep"]',function(){$(this).trigger("notify-hide")}),$(document).on("click",'main .page[path="group/information"] .notifyjs-PBL-unsaved-base [name="load"]',function(){m(),$(this).trigger("notify-hide")}),$(document).on("click",'main .page[path="group/members"] .notifyjs-PBL-unsaved-base [name="load"]',function(){a.isLeader&&($('main .page[path^="group/"] .settings [onClick^="PBL.save.settings"]').attr("disabled",""),t.mbr_settings.forEach(t=>{e.querySelector('main .page[path^="group/"] .settings [name="'+t+'"]').checked="Y"==a.groupSettings[t]}),a.state.loadSettingsOver=!0,b("group/members")),$(this).trigger("notify-hide")}))},o=async function(){await ajax(t.API_URL+"status",{type:"get",act:"personal"}).then(function(e){a.status=e,a.code=e.code;let t=r(a.status.isGrouped,"render");s(t)})},r=function(e=null,t=null){var a=location.hash.substring(2),n=[null];if(a.length){var i=a.split("/");!1==e?"group/new"==a?n=[a]:"group/join"==a?n=[a,null]:/^group\/join\/[A-Z0-9]{6}$/.test(a)&&(n=["group/join",i[2]]):!0==e&&/^(schedule|group\/(information|members)|file\/(documents|assignment)|comments)$/.test(a)&&(n=[a])}return n},s=function(e){null==e[1]&&e[2]>=0&&(a.status={isGrouped:!1},a.code=null);var n=a.status.isGrouped?"h":"n";$("main > .container").html(a.HTML["header-bar"]).append('<div class="wrapper tab-selector"><div class="tabs"></div></div>').append('<section class="pages"></section>');var i=$("main > .container .tab-selector .tabs").css("--tab-count",t.tab_menu[n+"g"].length);t.tab_menu[n+"g"].forEach(e=>i.append(t.HTML["tab-menu"](...e))),null==e[0]&&(e[0]=a.status.isGrouped?"schedule":"group/join"),$("main > .container .pages").load("/s/PBL/v2/blocks.html .pages[page-type="+n+"g]",function(){$("main > .container > .pages").html($("main > .container .pages > .pages").html()),"h"==n&&(l("schedule","block"),l("file/documents","checkIS"),l("file/assignment","readyTable"),chatApp.start("std",[a.code],!0),a.chatInit=!1),PBL.openPage(e[0],e)})},l=function(e,...n){switch(e){case"group/new":break;case"group/join":null==n[0]||"group/join"==n[0]?$('main .page[path="group/join"] [name="gjc"]').focus():n[0].length&&($('main .page[path="group/join"] [name="gjc"]').val(n[0]),$('main .page[path="group/join"] button').focus());break;case"schedule":if("block"==n[0]){var i=1,o="";t.timeline.forEach(e=>{(!e.sem||e.isPBL||!e.isPBL&&a.status.requireIS)&&(o+=t.HTML.timeline(i++,e),!e.sem&&i--)}),$('main .page[path="schedule"]').prepend('<div class="progress slider">'+o+"</div>").prepend("<p>ภาคเรียนที่ 1</p>")}else u();break;case"group/information":a.state.loadInfoOver?m():$('main .page[path="group/information"] .form').notify({title:"You have unsaved changes."},{className:"warning",elementPosition:"bottom right",autoHideDelay:6e4,clickToHide:!1,style:"PBL-unsaved"}),a.state.button_freeze=!0;break;case"group/members":$('main .page[path="group/members"] .code output[name="gjc"]').val(a.code),g();break;case"file/documents":"checkIS"==n[0]&&(a.status.requireIS||$('main .page[path="file/documents"] .files tr.isInIS').remove(),$('main .page[path="file/documents"] .files .act-group a[download]').attr("draggable","false"),isSafari&&$('main .page[path="file/documents"] .files .act-group a[download]').attr("target","_blank"),$('main .page[path="file/documents"] a:not([download])').attr("target","_blank").attr("draggable","false").each((e,t)=>{let a="/go?url="+encodeURIComponent(t.href);t.href=a}));break;case"file/assignment":if("readyTable"==n[0]){var r="";Object.keys(t.workload).forEach(e=>{(a.status.requireIS||"IS"!=e.substr(0,2))&&(r+='<tr><td><span class="--txtoe">'+t.workload[e]+'</span></td><td><div class="group center" data-work="'+e+'">',r+='</div></td><td center><output name="'+e+'"></output></td></tr>')}),$('main .page[path="file/assignment"] .work tbody').html(r)}else d();break;case"comments":a.chatInit||(a.chatInit=!0,chatApp.init(!0))}},p=function(e){void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),e.isGrouped&&(a.status=e,a.code=e.code,s([null]))},u=async function(){await ajax(t.API_URL+"status",{type:"work",act:"deadline"}).then(function(e){e?Object.keys(e).forEach(t=>{$('main .page[path="schedule"] output[deadline="'+t+'"]').val(e[t][0])}):$('main .page[path="schedule"] output[deadline]').val("ไม่พบข้อมูล"),a.deadlines=e}),await d().then(function(){var e=Date.now(),n=!1;a.workStatus?t.timeline.forEach(t=>{if(t.sem&&(t.isPBL||!t.isPBL&&a.status.requireIS)){var i=!0,o="p",r=new Date(a.deadlines[t.deadline][1]).getTime();Object.keys(t.works).forEach(e=>{i=i&&a.workStatus[e]}),e>r?o=i?"e":"m":n?o=i?"i":"p":(o=i?"e":"s",c(t.deadline)&&(n=!n)),$('main .page[path="schedule"] .sec-'+t.deadline+" .disp").attr("class","disp "+o)}}):$('main .page[path="schedule"] .sec .disp').attr("class","disp p")}).then(function(){if(a.deadlines,a.workStatus){a.status.requireIS||Object.keys(t.workload).forEach(e=>{/^IS\d-\d$/.test(e)&&delete a.workStatus[e]});var e=Object.keys(a.workStatus).length,n=100*Object.values(a.workStatus).filter(e=>e).length;n=n%e?Math.round(n/e*100)/100:n/e,$('main .page[path="schedule"] output[name="progress"]').val(n)}})},d=async function(){await ajax(t.API_URL+"status",{type:"work",act:"file"}).then(function(e){e?($('main .page[path="schedule"] .asgmt-list .work i').each((t,a)=>{var n=e[a.getAttribute("work")];$(a).attr("class","material-icons "+(n?"g":"r")).text(n?"done":"clear")}),Object.keys(e).forEach(a=>{if(!/^n\d+$/.test(a)){$('main .page[path="file/assignment"] .work output[name="'+a+'"]').attr("class",e[a]?"y":"n").val(e[a]?"ส่งแล้ว":"ไม่มีไฟล์");var n=e[a]?t.HTML["work-act"](a):'<button class="blue hollow icon" onClick="PBL.upload(\''+a+'\')"><i class="material-icons">add_circle</i>Upload attachment</button>';$('main .page[path="file/assignment"] .work [data-work="'+a+'"]').html(n).attr("class","group center"+(e[a]?" action":""))}})):sys.auth.orize(!0,!0),a.workStatus=e})},c=function(e){var t=Object.keys(a.deadlines),n=a.deadlines[t[t.indexOf(e)+1]];return void 0===n||a.deadlines[e][1]<n[1]},m=async function(){await ajax(t.API_URL+"information",{type:"group",act:"title"}).then(async function(e){if(void 0===e.isGrouped||e.isGrouped){e.score?($('main .page[path="group/information"] .score').fadeIn(),$('main .page[path="group/information"] .score [name="net"]').val(e.score).attr("class","color-"+" rrrog"[e.score]),$('main .page[path="group/information"] .score [name="ppr"]').val(null!=e.score_paper?e.score_paper+" ":"ไม่มี"),$('main .page[path="group/information"] .score [name="pst"]').val(null!=e.score_poster?e.score_poster+" ":"ไม่มี"),$('main .page[path="group/information"] .score [name="act"]').val(null!=e.score_activity?e.score_activity+" ":"ไม่มี")):($('main .page[path="group/information"] .score').fadeOut(),$('main .page[path="group/information"] .score [name="net"]').val("").removeAttr("class"),$('main .page[path="group/information"] .score:where([name="ppr"], [name="pst"], [name="act"])').val("")),["score","score_paper","score_poster","score_activity"].forEach(t=>delete e[t]),Object.keys(e).forEach(t=>$('main .page[path="group/information"] [name="'+t+'"]').val(e[t]||"")),a.state.loadInfoOver=!0,b(a.current.page);var n=[e.adv1,e.adv2,e.adv3].filter(e=>null!=e);if(n.length)await ajax(t.API_URL+"information",{type:"person",act:"teacher",param:n.join(",")}).then(function(e){Object.keys(e.list).forEach(t=>$('main .page[path="group/information"] [name="adv'+(n.indexOf(t)+1).toString()+'"] + input').val(e.list[t]));for(let t=Object.keys(e.list).length+1;t<=3;t++)$('main .page[path="group/information"] [name="adv'+t.toString()+'"] + input').val("")});else for(let i=1;i<=3;i++)$('main .page[path="group/information"] [name="adv'+i.toString()+'"] + input').val("")}else s([null,null,0]);return e}).then(function(e){e&&$("main .pages .page.current button").attr("disabled","")})},g=async function(n=!0){await ajax(t.API_URL+"information",{type:"group",act:"member"}).then(async function(i){void 0===i.isGrouped||i.isGrouped?(await ajax(t.API_URL+"information",{type:"person",act:"student",param:i.list.join(",")}).then(function(e){var n=1,i="";a.isLeader=t.USER==e.list[0].ID,e.list.forEach(e=>{i+="<tr><td>"+n.toString()+".</td><td>"+e.fullname+' (<a href="/user/'+e.ID+'" target="_blank" draggable="false">'+e.nickname+"</a>)</td><td>เลขที่ "+e.number+"</td><td>",1==n++?i+='<a role="button" class="default pill" disabled>หัวหน้ากลุ่ม</a>':a.isLeader&&(i+='<div class="group pill"><button onClick="PBL.kick('+e.ID+')" class="red hollow">ลบชื่อออก</button><button onClick="PBL.setLeader('+e.ID+')" class="yellow hollow icon" data-title="Set as leader">\uD83D\uDC51</button></div>'),i+="</td></tr>"}),$('main .page[path="group/members"] .list tbody').html(i),a.isLeader?$('main .page[path="group/members"] > p button').attr("onClick","PBL.terminate(true)").attr("class","yellow").text("ลบกลุ่ม"):$('main .page[path="group/members"] > p button').attr("onClick","PBL.terminate(false)").attr("class","red").text("ออกจากกลุ่ม")}),a.isLeader?(a.groupSettings=i.settings,$('main .page[path^="group/"] .settings').fadeIn(),n&&(a.state.loadSettingsOver?($('main .page[path^="group/"] .settings [onClick^="PBL.save.settings"]').attr("disabled",""),t.mbr_settings.forEach(t=>{e.querySelector('main .page[path^="group/"] .settings [name="'+t+'"]').checked="Y"==a.groupSettings[t]}),a.state.loadSettingsOver=!0,b(a.current.page)):$('main .page[path^="group/"] .settings').notify({title:"You have unsaved changes."},{className:"warning",elementPosition:"bottom center",autoHideDelay:6e4,clickToHide:!1,style:"PBL-unsaved"}))):$('main .page[path^="group/"] .settings').fadeOut()):s([null,null,0])})},h=async function(e,n=null){e||a.isLeader&&n==t.USER?a.isLeader?confirm(t.MSG["delete-group"])&&await ajax(t.API_URL+"group",{type:"delete",act:"void"}).then(function(e){void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),e&&s([null,null,1])}):app.ui.notify(1,[3,"You must be a leader to delete the group."]):confirm(t.MSG["delete-mbr"])&&await ajax(t.API_URL+"group",{type:"delete",act:"member",param:n||t.USER}).then(function(e){e&&(null!=n?(void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),g(!1)):(app.ui.notify(1,[0,"You left the group."]),s([null,null,2])))})},f=function(e){h(!1,e)},v=function(e){a.history.unsavedPage.length||$(window).bind("beforeunload",function(){return a.history.unsavedPage.includes(a.current.page)||PBL.openPage(a.history.unsavedPage[a.history.unsavedPage.length-1]),null}),a.history.unsavedPage.includes(e)||a.history.unsavedPage.push(e)},b=function(e){let t=a.history.unsavedPage.indexOf(e);t>-1&&a.history.unsavedPage.splice(t,1),a.history.unsavedPage.length||app.io.confirm("unleave")};return{init:function(){if(!a.started){if(a.started=!0,!t.USER.length)return sys.auth.orize(!0,!0);a.HTML["header-bar"]=$("main > .container").html(),o(),i()}},openPage:function(t,n=[]){"string"==typeof t&&(t=e.querySelector('main .tab-selector .tab[data-page="'+t+'"]'));var i=$(t).attr("data-page");if(i==a.current.page)return!1;n.length,history.replaceState(null,null,location.pathname+location.search+"#/"+i),a.current.page=i,$("main .tab-selector .tab.active").removeClass("active"),$(t).addClass("active"),$("main .pages .page.current").removeClass("current"),$('main .pages .page[path="'+i+'"]').addClass("current"),n.length>1&&n.shift(),l(i,...n)},help:function(t=null){if(null==t)app.ui.lightbox.open("mid",{title:"ความช่วยเหลือ",allowclose:!0,html:e.querySelector("main > .manual[hidden]").innerHTML});else{let a=$("main > .manual[hidden] a[href$=\"PBL.help('"+t+"')\"]").attr("data-href");switch(t){case"document":{let n=[$(".lightbox .body").width().toString()+"px",$(".lightbox .body").height().toString()+"px"];$(".lightbox .body").html('<iframe src="'+a+'" style="width:'+n[0]+";height:"+n[1]+';border:none">Loading...</iframe>'),$(".lightbox .body > iframe").animate({width:"90vw",height:"80vh"});break}case"mediaVDO":{let i=[$(".lightbox .body").width().toString()+"px",$(".lightbox .body").height().toString()+"px"];$(".lightbox .body").html('<iframe src="'+a+'" style="width:'+i[0]+";height:"+i[1]+';border:none">Loading...</iframe>');var o=[$(window).width(),$(window).height()];o[0]>o[1]?(o[1]*=.8,o[0]=16*o[1]/9):(o[0]*=.9,o[1]=9*o[0]/16),$(".lightbox .body > iframe").animate({width:o[0].toString()+"px",height:o[1].toString()+"px"});break}default:window.open(a),app.ui.lightbox.close()}}},createGroup:function(e){return!async function(e){if(e){var a={nameth:$('main .page[path="group/new"] [name="nameth"]').val().trim().replaceAll("เเ","แ"),nameen:$('main .page[path="group/new"] [name="nameen"]').val().trim().replaceAll("เเ","แ"),adv1:$('main .page[path="group/new"] [name="adv1"]').val(),adv2:$('main .page[path="group/new"] [name="adv2"]').val(),adv3:$('main .page[path="group/new"] [name="adv3"]').val(),type:$('main .page[path="group/new"] [name="type"]').val()};a.nameth.length&&!/^[ก-๛0-9A-Za-z ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(a.nameth)?(app.ui.notify(1,[2,"Invalid Thai project name."]),$('main .page[path="group/new"] [name="nameth"]').focus()):a.nameen.length&&!/^[A-Za-z0-9ก-๛ ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(a.nameen)?(app.ui.notify(1,[2,"Invalid English project name."]),$('main .page[path="group/new"] [name="nameen"]').focus()):" ABCDEFGHIJKLM".includes(a.type)?(n.freeze(),await ajax(t.API_URL+"group",{type:"create",act:"new-group",param:a}).then(p).then(n.unfreeze)):(app.ui.notify(1,[2,"Invalid project type."]),$('main .page[path="group/new"] [name="type"]').focus())}else $('main .page[path="group/new"] input, main .page[path="group/new"] select').val("")}(e),!1},joinGroup:function(){return!async function(){var e=$('main .page[path="group/join"] [name="gjc"]').val().trim().toUpperCase();e.length?/^[A-Z0-9]{6}$/.test(e)?(n.freeze(),await ajax(t.API_URL+"group",{type:"join",act:"existing-group",param:e}).then(p).then(n.unfreeze)):(app.ui.notify(1,[2,"Invalid group code."]),$('main .page[path="group/join"] [name="gjc"]').focus()):(app.ui.notify(1,[2,"Group code empty."]),$('main .page[path="group/join"] [name="gjc"]').focus())}(),!1},terminate:h,kick:f,setLeader:async function(e){e==t.USER?app.ui.notify(1,a.isLeader?[1,"You are already a group leader."]:[2,"You can't promote yourself as a group leader."]):confirm(t.MSG.newLeader)&&await ajax(t.API_URL+"group",{type:"update",act:"leader",param:e}).then(function(e){e&&(void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),g(!0))})},upload:function(e){if(!1==e){PBL.save.file(!1);return}a.current.workType=e,app.ui.lightbox.open("mid",{allowclose:!0,html:'<iframe src="upload" style="width:90vw;height:712px;border:none">Loading...</iframe>'})},save:{info:function(){return!async function(){var e={nameth:$('main .page[path="group/information"] [name="nameth"]').val().trim().replaceAll("เเ","แ"),nameen:$('main .page[path="group/information"] [name="nameen"]').val().trim().replaceAll("เเ","แ"),adv1:$('main .page[path="group/information"] [name="adv1"]').val(),adv2:$('main .page[path="group/information"] [name="adv2"]').val(),adv3:$('main .page[path="group/information"] [name="adv3"]').val(),type:$('main .page[path="group/information"] [name="type"]').val()};e.nameth.length&&!/^[ก-๛0-9A-Za-z ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(e.nameth)?(app.ui.notify(1,[2,"Invalid Thai project name."]),$('main .page[path="group/information"] [name="nameth"]').focus()):e.nameen.length&&!/^[A-Za-z0-9ก-๛ ()[\]{}\-!@#$%.,/&*+_?|]{3,150}$/.test(e.nameen)?(app.ui.notify(1,[2,"Invalid English project name."]),$('main .page[path="group/information"] [name="nameen"]').focus()):" ABCDEFGHIJKLM".includes(e.type)?(n.freeze(),await ajax(t.API_URL+"group",{type:"update",act:"information",param:e}).then(function(e){void 0===e.isGrouped||e.isGrouped?void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)):s([null,null,0])}).then(n.unfreeze).then(function(){$("main .pages .page.current button").attr("disabled",""),a.state.loadInfoOver=!0,b(a.current.page)})):(app.ui.notify(1,[2,"Invalid project type."]),$('main .page[path="group/information"] [name="type"]').focus())}(),!1},settings:async function(n){if(void 0===a.groupSettings[n])app.ui.notify(1,[3,"Setting not found."]);else{var i,o=(i=n,t.mbr_settings.includes(i)?e.querySelector('main .page[path^="group/"] .settings [name="'+i+'"]').checked?"Y":"N":[null]),r=$('main .page[path^="group/"] .settings [onClick="PBL.save.settings(\''+n+"')\"]");o==[null]&&app.ui.notify(1,[3,"Error validating your setting."]),a.groupSettings[n]==o?(app.ui.notify(1,[1,"No change applies."]),r.attr("disabled","")):await ajax(t.API_URL+"information",{type:"settings",act:"member",param:[n,o]}).then(function(e){void 0!==e.message&&e.message.forEach(e=>app.ui.notify(1,e)),e&&(a.groupSettings[n]=o,r.attr("disabled",""))})}},file:function(e){app.ui.lightbox.close(),"complete"==e&&d(),a.current.workType=""}},file:{preview:function(e){app.ui.lightbox.open("mid",{title:"ไฟล์"+t.workload[e],allowclose:!0,html:'<iframe src="preview?file='+e+'" style="width:90vw;height:80vh;border:none">Loading...</iframe>'})},print:async function(e){var a=$('main .page[path="file/assignment"] .work [data-work="'+e+'"] button[onClick*="print"]');await ajax(t.API_URL+"status",{type:"get",act:"fileLink",param:e}).then(function(e){void 0===e.isGrouped||e.isGrouped?(e.print?(e.print=atob(e.print),/.+\.pdf$/.test(e.print)?printJS(e.print):printJS(e.print,"image")):app.ui.notify(1,[3,"There's a problem preparing your file for print."]),setTimeout(function(){a.removeAttr("disabled")},500)):s([null,null,0])}),a.attr("disabled","")},download:async function(a){var n=$('main .page[path="file/assignment"] .work [data-work="'+a+'"] button[onClick*="download"]');await ajax(t.API_URL+"status",{type:"get",act:"fileLink",param:a}).then(function(t){void 0===t.isGrouped||t.isGrouped?t.download?(e.querySelector('main iframe[name="dlframe"]').src=t.download,setTimeout(function(){n.removeAttr("disabled")},5e3)):(n.removeAttr("disabled"),app.ui.notify(1,[3,"There's a problem downloading your file."])):s([null,null,0])}),n.attr("disabled","")},remove:async function(e){if(confirm(t.MSG["del-work"](t.workload[e]))){var a=$('main .page[path="file/assignment"] .work [data-work="'+e+'"] button[onClick*="remove"]');await ajax(t.API_URL+"main",{type:"work",act:"remove",param:e}).then(function(e){void 0===e.isGrouped||e.isGrouped?e||a.removeAttr("disabled"):s([null,null,0]),d()}),a.attr("disabled","")}}},btnAction:n,groupCode:()=>a.code,pageURL:()=>a.current.page,uploadType:()=>a.current.workType,setState:(e,t)=>a.state[e]=t,confirmLeave:v}}(document);top.PBL=PBL;